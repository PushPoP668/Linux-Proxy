###############################################################################
# sing-box 安装与启用阶段完整记录（Linux / Ubuntu / x86_64）
#
# 目标：
# - 手动安装 sing-box（无 GitHub 直连）
# - 使用机场节点（hysteria2 / vless / shadowsocks 等）
# - 后台运行 + 开机自启
# - 登录后自动具备代理环境
###############################################################################


###############################################################################
# 一、环境与前置说明
###############################################################################

# 操作系统：Ubuntu（systemd）
# 架构：x86_64 / amd64
# 说明：
# - v2rayN 为 Windows GUI 客户端，Linux 服务器不使用
# - sing-box 为现代代理核心，支持 hysteria2 / vless / ss
# - 服务器无法访问 GitHub，采用手动安装方式


###############################################################################
# 二、sing-box 手动安装
###############################################################################

# 1. 解压下载好的 sing-box 压缩包
# （文件名以实际版本为准）
tar -xzf sing-box-*-linux-amd64.tar.gz

# 2. 准备安装目录
sudo mkdir -p /usr/local/bin

# 3. 安装二进制
sudo install -m 755 sing-box /usr/local/bin/sing-box

	验证：如果能看到版本号，说明 内核已经就位
	sing-box version

# 4. 准备配置文件目录
sudo mkdir -p /usr/local/etc/sing-box

	配置文件路径：/usr/local/etc/sing-box/config.json
	# 配置文件暂时需要寻求AI帮助
	

###############################################################################
# 三、配置检查与手动运行测试
###############################################################################

# 1. 检查配置文件是否合法
sing-box check -c /usr/local/etc/sing-box/config.json
# 无输出 = 配置正确

# 2. 前台运行 sing-box（测试用）
sing-box run -c /usr/local/etc/sing-box/config.json

# 3. 看到类似输出说明启动成功：
# inbound/mixed: tcp server started at 127.0.0.1:10808

# 4. 新开一个 SSH 窗口测试：
	# 设置临时环境变量（仅在当前 SSH 窗口生效）：export ALL_PROXY=socks5h://127.0.0.1:10808
	# curl https://google.com
	
	# 看到旧 SSH 窗口类似输出说明通信成功：
	# INFO[0019] [2080347651 0ms] outbound/hysteria2[proxy]: outbound connection to google.com:443
	
	# 移除临时环境变量：unset ALL_PROXY
	
	# PS . 只对当前命令生效：ALL_PROXY=socks5h://127.0.0.1:10808 curl https://google.com
 
###############################################################################
# 四、配置 systemd（后台运行 + 开机自启）
###############################################################################

# 1. 创建 systemd 服务文件
sudo nano /etc/systemd/system/sing-box.service

# 2. 服务内容如下：
[Unit]
Description=Sing-box Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/sing-box run -c /usr/local/etc/sing-box/config.json
Restart=on-failure
RestartSec=5
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target


# 3. 重新加载 systemd
sudo systemctl daemon-reload

# 4. 设置开机自启
sudo systemctl enable sing-box

# 5. 启动 sing-box 服务
sudo systemctl start sing-box

# 6. 查看运行状态
systemctl status sing-box --no-pager
# Active: active (running) = 成功


###############################################################################
# 五、理解关键概念（非常重要）
###############################################################################

# sing-box 后台运行 ≠ 系统自动走代理
#
# sing-box 只是“提供代理服务”
# Linux 程序是否走代理，取决于：
# - 是否设置代理环境变量
# - 程序本身是否支持代理


###############################################################################
# 六、设置「登录即自动使用代理」
###############################################################################

# 1. 编辑 bash 启动文件
nano ~/.bashrc

# 2. 在文件末尾加入：
# ------------------------------------------------
# === sing-box proxy ===
export ALL_PROXY="socks5h://127.0.0.1:10808"
export http_proxy="$ALL_PROXY"
export https_proxy="$ALL_PROXY"
# ------------------------------------------------

# 3. 立即生效（无需重登）
source ~/.bashrc

# 4. 验证
curl ip.sb
# 返回节点 IP = 成功

# 5. 重新 SSH 登录后，无需再手动 export


###############################################################################
# 七、当前阶段完成状态
###############################################################################

# 已完成：
# - sing-box 手动安装
# - 配置 hysteria2 / vless / ss 节点
# - 本地 127.0.0.1:10808 混合代理
# - systemd 后台运行
# - 开机自启
# - 登录自动代理环境
# - 成功访问 Google / 外网


###############################################################################
# 十、当前网络结构示意
###############################################################################

# 应用程序（curl / git / apt）
#          ↓
#   环境变量 ALL_PROXY
#          ↓
#   127.0.0.1:10808
#          ↓
#       sing-box
#          ↓
#   机场节点（hysteria2 / vless / ss）
#          ↓
#        Internet
###############################################################################
